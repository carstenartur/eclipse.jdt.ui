# Fork Workflow

This fork (`carstenartur/eclipse.jdt.ui`) maintains custom CI workflows, badges, and build
configurations on top of `eclipse-jdt/eclipse.jdt.ui`. Three GitHub Actions workflows work
together to keep things clean.

```
eclipse-jdt/eclipse.jdt.ui (upstream)
  └── master ← the "source of truth"
        │
        │  sync-upstream.yml (nightly)
        │  resets fork master to upstream,
        │  re-applies fork-specific files
        ▼
carstenartur/eclipse.jdt.ui (fork)
  └── master = upstream/master + 1 "fork customizations" commit
      │
      ├── Feature branches: develop/test fixes here
      │
      └── upstream-pr/issue-XXXX: clean branches for upstream PRs
          (created by create-upstream-pr.yml)
```

## The Three Workflows

### `sync-upstream.yml` — Nightly Sync

Reads `.github/fork-specific-files.txt`, backs up those files, resets `master` to
`upstream/master`, restores fork files as one commit, and force-pushes.

Can also be triggered manually via `workflow_dispatch` or by commenting `/sync-upstream` on
any issue.

### `create-upstream-pr.yml` — Create Clean Upstream PR Branch

Accepts the following inputs:

| Input | Description |
|---|---|
| `issue_number` | Upstream issue number |
| `source_branch` | Branch containing the fix commits |
| `commit_shas` | Comma-separated list of commit SHAs to cherry-pick |
| `pr_title` | Title for the upstream PR |

Fetches `upstream/master`, creates `upstream-pr/issue-{number}` branch, cherry-picks only
the specified commits, force-pushes, and outputs a link to open the PR on upstream.

### `rebase-upstream.yml` — Rebase PR Branch onto Upstream

Rebases existing `upstream-pr/*` branches onto the latest `upstream/master` using
`git merge-base`. Triggered by commenting `/rebase-upstream` on any PR.

## Step-by-Step Guide: From Fork Development to Upstream PR

### 1. Develop and test in your fork

Work on `master` or a feature branch. Keep fix commits separate from fork customizations so
they can be cherry-picked cleanly.

### 2. Identify commit SHAs

```bash
git log --oneline
```

Note only the SHAs of the relevant fix commits (not fork customization commits).

### 3. Run "Create Clean Upstream PR" workflow

Go to **Actions → Create Clean Upstream PR → Run workflow** and fill in:

- `issue_number` — upstream issue number
- `source_branch` — the branch with your fix commits
- `commit_shas` — comma-separated SHAs from step 2
- `pr_title` — descriptive title for the upstream PR

### 4. Open the PR on upstream

Click the link generated by the workflow output to open the PR on
`eclipse-jdt/eclipse.jdt.ui`.

### 5. Update the PR later

- Re-run the `create-upstream-pr.yml` workflow with updated SHAs to replace the branch, or
- Comment `/rebase-upstream` on the PR to rebase onto the latest upstream master.

## File Reference

| File | Purpose |
|---|---|
| `.github/fork-specific-files.txt` | Lists fork-only file paths preserved across syncs |
| `.github/workflows/sync-upstream.yml` | Nightly sync of fork master to upstream |
| `.github/workflows/create-upstream-pr.yml` | Creates clean branches for upstream PRs |
| `.github/workflows/rebase-upstream.yml` | Rebases PR branches onto `upstream/master` |
| `.github/workflows/rebase.yml` | Rebases PRs within the fork |

## Preconditions

No settings changes needed.

| Precondition | Status |
|---|---|
| Default branch is `master` (matching upstream) | ✅ |
| Fork has `master` branch | ✅ |
| Upstream remote is `eclipse-jdt/eclipse.jdt.ui` | ✅ (hardcoded in workflows) |
| `GITHUB_TOKEN` has `contents: write` | ✅ (default for fork owner) |
| `.github/fork-specific-files.txt` exists | ✅ |
| `allow_rebase_merge` enabled | ✅ |
| `allow_squash_merge` enabled | ✅ |

## Common Scenarios

**"I already have a PR on upstream that's polluted with fork commits"**
→ Run `create-upstream-pr.yml` with the correct fix SHAs, close the old PR, and open the
new one from the generated link.

**"I want to add a new fork-specific file"**
→ Add the file path to `.github/fork-specific-files.txt`. It will be preserved across
nightly syncs.

**"The nightly sync failed"**
→ Check for conflicts. The workflow creates a `sync-conflict-YYYYMMDD` branch for manual
resolution.

## Important Rules

- **Never branch off fork's master for upstream PRs** — always use `create-upstream-pr.yml`
  or branch directly from `upstream/master`.
- **Keep fix commits atomic** — one commit per logical change, separate from fork
  customizations.
- **Verify before opening upstream PRs** — check the diff against upstream:

  ```bash
  git log upstream/master..HEAD --oneline
  git diff upstream/master..HEAD --stat
  ```
